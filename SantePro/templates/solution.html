<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier Patient Num√©rique (Maquette)</title>
    <style>
        /* --- Styles G√©n√©raux --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* R√©gl√© par le JS au d√©marrage */
            min-height: 100vh;
        }
        
        /* Conteneurs principaux */
        #appContainer {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            box-sizing: border-box;
            display: none; /* Cach√© par d√©faut, visible apr√®s authentification */
        }
        
        #authScreen {
            width: 90%;
            max-width: 400px;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
        }

        .hidden {
            display: none !important;
        }

        /* Titres */
        h1, h2, h3 {
            color: #333;
        }
        
        /* Formulaires & Entr√©es */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-row > .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea {
            resize: vertical;
        }

        /* Boutons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        /* Alertes */
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* --- Header de l'Application --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .user-info {
            font-size: 0.9em;
            color: #495057;
            text-align: right;
        }

        /* --- Menu Principal (Dashboard) --- */
        #mainMenu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .menu-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            border-left: 5px solid #007bff;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .menu-card h3 {
            margin-top: 10px;
            margin-bottom: 0;
            color: #007bff;
        }
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-card h4 {
            margin: 0 0 5px 0;
            font-size: 1.5em;
            color: #333;
        }
        .stat-card p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        /* --- Sections de Contenu --- */
        .content-area {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
            margin-bottom: 20px;
        }
        .content-area.active {
            display: block;
        }

        /* Nouvelle Consultation & R√©sum√© */
        #newConsultation h2, #medicalSummary h2 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-section-header {
            margin-top: 30px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            color: #007bff;
        }
        
        /* Ancienne Consultation */
        #searchArea {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #searchInput {
            flex-grow: 1;
        }

        /* Liste des Patients */
        .patients-list-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .patient-search-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .patient-search-card:last-child {
            border-bottom: none;
        }
        .patient-search-card:hover {
            background-color: #f8f9fa;
        }
        .patient-search-card a {
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }
        .patient-search-card a:hover {
            color: #007bff;
        }

        /* D√©tails du Patient et Historique */
        #patientDetails {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            background: #f9f9f9;
        }
        #patientInfo p {
            margin-top: 0;
            margin-bottom: 5px;
        }
        #patientInfo label {
            font-weight: normal;
        }
        .details-section-header {
            margin-top: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            color: #007bff;
        }
        .consultation-item-maquette {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .consultation-item-maquette h4 {
            margin-top: 0;
            color: #007bff;
        }
        .consultation-item-maquette .info-line {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .other-service {
            border-left: 5px solid #ffc107; /* Pour indiquer un autre service */
        }
        
        /* Prescription Editor */
        #prescriptionContent {
            font-family: monospace;
            height: 300px;
        }
        #editorToolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* Settings Subsections */
        #settingsMenu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        .settings-card {
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-left: 5px solid #28a745;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        .settings-card:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>

    <div id="authScreen" style="display: none;">
        <h2>üîê Connexion / Inscription</h2>
        
        <div id="authAlert"></div>

        <div id="loginView" class="hidden">
            <h3>Se connecter</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="userEmail">Email ou Nom d'utilisateur</label>
                    <input type="text" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Mot de passe</label>
                    <input type="password" id="userPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Se Connecter</button>
            </form>
            <p style="text-align: center; margin-top: 15px;">
                Pas de compte ? <a href="#" onclick="toggleAuthView('register'); return false;">S'inscrire ici</a>
            </p>
        </div>

        <div id="registerView" class="hidden">
            <h3>S'inscrire (Nouveau Soignant)</h3>
            <form id="registerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="regFirstName">Pr√©nom</label>
                        <input type="text" id="regFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="regLastName">Nom</label>
                        <input type="text" id="regLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="regUsername">Nom d'utilisateur</label>
                        <input type="text" id="regUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="regRole">R√¥le</label>
                        <select id="regRole" required>
                            <option value="M√©decin">M√©decin</option>
                            <option value="Infirmier(√®re)">Infirmier(√®re)</option>
                            <option value="Secr√©taire">Secr√©taire</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regService">Service (Affectation)</label>
                        <select id="regService" required>
                            <option value="Consultation g√©n√©rale">Consultation g√©n√©rale</option>
                            <option value="P√©diatrie">P√©diatrie</option>
                            <option value="Gyn√©cologie">Gyn√©cologie</option>
                            <option value="Chirurgie">Chirurgie</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="regPhone">T√©l√©phone (Optionnel)</label>
                    <input type="tel" id="regPhone">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="regPassword">Mot de passe</label>
                        <input type="password" id="regPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirmer le Mot de passe</label>
                        <input type="password" id="regConfirmPassword" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">Cr√©er le Compte</button>
            </form>
            <p style="text-align: center; margin-top: 15px;">
                D√©j√† inscrit ? <a href="#" onclick="toggleAuthView('login'); return false;">Se connecter</a>
            </p>
        </div>
    </div>

    <div id="appContainer" style="display: none;">
        
        <header>
            <h1>üè• Dossier Patient Num√©rique</h1>
            <div class="user-info">
                Bienvenue, <strong id="currentUserInfo"></strong> 
                <button class="btn btn-danger btn-sm" onclick="clearAuthData()" title="D√©connexion" style="margin-left: 10px;">
                    <span role="img" aria-label="door">üö™</span>
                </button>
            </div>
        </header>

        <button class="btn btn-secondary" onclick="showMainMenu()" style="margin-bottom: 20px;">
            &#x2B05; Retour au Menu Principal
        </button>

        <div id="mainMenu" style="display: none;">
            
            <div class="stat-card" style="grid-column: span 3; border-left: 5px solid #28a745;">
                <p>Consultations enregistr√©es dans le Service <strong id="currentServiceDisplay"></strong></p>
                <h4 id="consultationsCount">0</h4>
            </div>
            
            <div class="menu-card" onclick="showSection('newConsultation')">
                <span style="font-size: 2em;">‚ûï</span>
                <h3>Nouvelle Consultation</h3>
                <p>Enregistrer les informations d'un nouveau patient.</p>
            </div>
            
            <div class="menu-card" onclick="showSection('oldConsultation')">
                <span style="font-size: 2em;">üìÇ</span>
                <h3>Ancienne Consultation</h3>
                <p>Rechercher un patient et consulter son historique.</p>
            </div>
            
            <div class="menu-card" onclick="showSection('stats')">
                <span style="font-size: 2em;">üìä</span>
                <h3>Statistiques</h3>
                <p>Voir le rapport sur les maladies et les activit√©s.</p>
            </div>
            
            <div class="menu-card" onclick="showSection('settings')">
                <span style="font-size: 2em;">‚öôÔ∏è</span>
                <h3>Param√®tres</h3>
                <p>G√©rer votre profil et votre s√©curit√©.</p>
            </div>
            
        </div>

        <div id="newConsultation" class="content-area">
            <h2>√âtape 1/3: Enregistrement du Patient</h2>
            <div id="newConsultAlert"></div>
            <form id="newPatientForm">
                
                <h3 class="form-section-header">Informations du Patient</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientName">Nom complet du patient *</label>
                        <input type="text" id="patientName" required>
                    </div>
                    <div class="form-group">
                        <label for="patientAge">√Çge *</label>
                        <input type="number" id="patientAge" required min="1">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientGender">Sexe *</label>
                        <select id="patientGender" required>
                            <option value="M">Masculin</option>
                            <option value="F">F√©minin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patientProfession">Profession</label>
                        <input type="text" id="patientProfession">
                    </div>
                </div>
                
                <h3 class="form-section-header">Contact & Service</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientPhone">T√©l√©phone</label>
                        <input type="tel" id="patientPhone">
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Service d'enregistrement *</label>
                        <select id="serviceType" required>
                            <option value="Consultation g√©n√©rale">Consultation g√©n√©rale</option>
                            <option value="P√©diatrie">P√©diatrie</option>
                            <option value="Gyn√©cologie">Gyn√©cologie</option>
                            <option value="Chirurgie">Chirurgie</option>
                            </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="patientAddress">Adresse</label>
                    <input type="text" id="patientAddress">
                </div>
                
                <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                    √âtape Suivante (Prescription) ‚û°Ô∏è
                </button>
            </form>
        </div>

        <div id="prescriptionEditor" class="content-area">
            <h2>√âtape 2/3: Prescription & D√©tails</h2>
            <p>Patient : <strong id="currentPatientNameDisplay2"></strong></p>
            <div id="editorAlert"></div>

            <form id="prescriptionForm">
                <h3 class="form-section-header">Contenu de la Prescription (Max 50 lignes / 60 caract√®res par ligne)</h3>
                
                <div id="editorToolbar">
                    <button type="button" class="btn btn-secondary" onclick="addTable()">Ajouter un Tableau ASCII</button>
                    </div>
                
                <div class="form-group">
                    <textarea id="prescriptionContent" rows="15" placeholder="Saisissez ici la liste des m√©dicaments, posologies ou toute note d√©taill√©e de la consultation. Format texte uniquement." required></textarea>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="showSection('newConsultation')">
                        &#x2B05; Retour Enregistrement
                    </button>
                    <button type="submit" class="btn btn-primary">
                        √âtape Suivante (R√©sum√©) ‚û°Ô∏è
                    </button>
                </div>
            </form>
        </div>

        <div id="medicalSummary" class="content-area">
            <h2>√âtape 3/3: R√©sum√© et Sauvegarde</h2>
            <p>Patient : <strong id="currentPatientNameDisplay3"></strong></p>

            <form id="summaryForm">
                <h3 class="form-section-header">D√©tails de la Consultation</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="diseaseType">Type de Maladie / Diagnostic Principal *</label>
                        <input type="text" id="diseaseType" placeholder="Ex: Paludisme Simple, Hypertension Art√©rielle" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="summaryText">Observations Utiles (Historique familial, allergies, etc.)</label>
                    <textarea id="summaryText" rows="4"></textarea>
                </div>
                
                <h3 class="form-section-header">Informations du Soignant (Pr√©-rempli)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="doctorName">Nom du Soignant *</label>
                        <input type="text" id="doctorName" readonly required>
                    </div>
                    <div class="form-group">
                        <label for="doctorService">Service de la Consultation *</label>
                        <input type="text" id="doctorService" readonly required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="doctorContact">Contact du Soignant (Tel/Email)</label>
                        <input type="text" id="doctorContact" readonly>
                    </div>
                    <div class="form-group">
                        <label for="consultationCenter">Centre de Consultation *</label>
                        <input type="text" id="consultationCenter" required>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="showSection('prescriptionEditor')">
                        &#x2B05; Retour Prescription
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveConsultation()">
                        üíæ ENREGISTRER LA CONSULTATION
                    </button>
                </div>
            </form>
        </div>

        <div id="oldConsultation" class="content-area">
            <h2>Recherche d'Anciennes Consultations</h2>
            
            <div id="searchArea">
                <input type="text" id="searchInput" onkeyup="searchPatients()" placeholder="Rechercher par Nom, ID ou T√©l√©phone...">
                <button type="button" class="btn btn-primary" onclick="searchPatients()">Rechercher</button>
            </div>
            
            <h3 style="margin-top: 0;">Dossiers Consult√©s R√©cemment (Service : <strong id="listServiceDisplay"></strong>)</h3>
            
            <div class="patients-list-container">
                <div id="patientListContent">
                    <p style="padding: 10px;">Veuillez taper au moins 2 caract√®res ou voir la liste r√©cente apr√®s le premier chargement.</p>
                </div>
            </div>
            
            <div id="patientDetails" class="patient-details hidden">
                <h3 class="details-section-header">Informations du Patient</h3>
                <div id="patientInfo">
                    </div>
                
                <button type="button" class="btn btn-primary" onclick="continueConsultation()" style="margin-top: 20px;">
                    ‚ûï Reprendre la Consultation (Cr√©er une nouvelle entr√©e)
                </button>

                <div id="consultationHistory">
                    </div>
                
                </div>
        </div>
        
        <div id="stats" class="content-area">
            <h2>Rapport Statistique par Service</h2>
            
            <div id="statAlert"></div>
            
            <div id="statCardsContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div class="stat-card" style="border-left: 5px solid #007bff;">
                    <p>Total Consultations (<span id="statsFilter">Tous Services</span>)</p>
                    <h4 id="totalConsultsStat">0</h4>
                </div>
                <div class="stat-card" style="border-left: 5px solid #28a745;">
                    <p>Total Patients enregistr√©s</p>
                    <h4 id="totalPatientsStat">0</h4>
                </div>
            </div>
            
            <h3 class="details-section-header" style="margin-top: 30px;">Top 5 des Maladies (Toutes P√©riodes)</h3>
            <div class="patients-list-container">
                <ul id="topDiseasesList" style="padding: 10px 20px; list-style: decimal;">
                    <li>Aucune donn√©e pour l'instant.</li>
                </ul>
            </div>
        </div>

        <div id="settings" class="content-area">
            <h2>Param√®tres du Compte</h2>
            
            <div id="settingsMenu">
                <div class="settings-card" onclick="showSettingsSubSection('profileDetails')">
                    Modifier le Profil
                </div>
                <div class="settings-card" onclick="showSettingsSubSection('securityDetails')">
                    Changer le Mot de Passe
                </div>
            </div>

            <div id="profileDetails" class="patient-details hidden">
                <h3 class="details-section-header">Modifier mes Informations</h3>
                <div id="profileAlert"></div>
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nom et Pr√©nom</label>
                            <input type="text" id="editName" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Nom d'utilisateur</label>
                            <input type="text" id="editUsername" readonly disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>R√¥le</label>
                            <input type="text" id="editRole" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Service</label>
                            <input type="text" id="editService" readonly disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">T√©l√©phone</label>
                        <input type="tel" id="editPhone">
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="showSettingsSubSection('settingsMenu')">
                            &#x2B05; Retour Menu Param√®tres
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Enregistrer les Modifications
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="securityDetails" class="patient-details hidden">
                <h3 class="details-section-header">Changer le Mot de Passe</h3>
                <div id="securityAlert"></div>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="oldPassword">Ancien Mot de Passe *</label>
                        <input type="password" id="oldPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Nouveau Mot de Passe *</label>
                        <input type="password" id="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">Confirmer le Nouveau Mot de Passe *</label>
                        <input type="password" id="confirmNewPassword" required>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="showSettingsSubSection('settingsMenu')">
                            &#x2B05; Retour Menu Param√®tres
                        </button>
                        <button type="submit" class="btn btn-danger">
                            Changer et Se D√©connecter
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div> <script>
        // Structure de donn√©es de l'application
        let patients = [];
        let consultations = [];
        let currentPatient = null;
        let currentPrescription = '';
        
        // Structure de donn√©es de l'utilisateur (stock√©es localement)
        let storedUser = JSON.parse(localStorage.getItem('storedUser')) || null;

        // --- Fonctions d'Authentification ---
        function updateStoredUser(user) {
            storedUser = user;
            localStorage.setItem('storedUser', JSON.stringify(user));
        }
        
        function loadData() {
            // Charger les donn√©es patients/consultations associ√©es √† l'utilisateur logg√© (Simul√©)
            // Pour une maquette simple, nous stockons toutes les donn√©es ensemble
            patients = JSON.parse(localStorage.getItem('patientsData')) || [];
            consultations = JSON.parse(localStorage.getItem('consultationsData')) || [];
        }

        function saveData() {
            localStorage.setItem('patientsData', JSON.stringify(patients));
            localStorage.setItem('consultationsData', JSON.stringify(consultations));
        }

        function showAuthScreen() {
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('authScreen').style.display = 'block';
            document.body.style.alignItems = 'center';
            document.body.style.padding = '0';
            if (storedUser) {
                toggleAuthView('login');
                // Pr√©-remplir l'email ou le username si un utilisateur existe
                document.getElementById('userEmail').value = storedUser.email || storedUser.username || ''; 
            } else {
                toggleAuthView('register');
            }
        }

        function toggleAuthView(view) {
            document.getElementById('authAlert').innerHTML = '';
            document.getElementById('registerView').classList.add('hidden');
            document.getElementById('loginView').classList.add('hidden');
            
            if (view === 'register') {
                document.getElementById('registerView').classList.remove('hidden');
            } else if (view === 'login') {
                document.getElementById('loginView').classList.remove('hidden');
            }
        }
        
        function clearAuthData() {
            localStorage.removeItem('isLoggedIn');
            showAuthScreen();
            document.getElementById('authAlert').innerHTML = '<div class="alert alert-success">üö™ D√©connexion r√©ussie !</div>';
        }

        function checkAuth() {
            if (localStorage.getItem('isLoggedIn') === 'true' && storedUser) {
                startApp();
            } else {
                showAuthScreen();
            }
        }

        // G√©rer la soumission du formulaire de Connexion
        document.getElementById('loginForm').onsubmit = function(e) {
            e.preventDefault();
            const emailOrUsername = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const alertDiv = document.getElementById('authAlert');

            if (storedUser && 
                (storedUser.email === emailOrUsername || storedUser.username === emailOrUsername) && 
                storedUser.password === password) {
                
                localStorage.setItem('isLoggedIn', 'true');
                alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Connexion r√©ussie ! Redirection...</div>';
                document.getElementById('loginForm').reset();
                setTimeout(startApp, 1000);
            } else {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Identifiants incorrects. Veuillez v√©rifier vos informations ou vous inscrire.</div>';
            }
        };

        // G√©rer la soumission du formulaire d'Inscription
        document.getElementById('registerForm').onsubmit = function(e) {
            e.preventDefault();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const alertDiv = document.getElementById('authAlert');

            if (password !== confirmPassword) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Le mot de passe et sa confirmation ne correspondent pas.</div>';
                return;
            }
            
            if (password.length < 6) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Le mot de passe doit contenir au moins 6 caract√®res.</div>';
                return;
            }

            const newUser = {
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                phone: document.getElementById('regPhone').value,
                role: document.getElementById('regRole').value,
                service: document.getElementById('regService').value,
                password: password,
            };

            updateStoredUser(newUser);

            alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Inscription r√©ussie ! Veuillez vous connecter.</div>';
            document.getElementById('registerForm').reset();
            toggleAuthView('login');
        };
        
        // Fonction pour pr√©-remplir le formulaire de profil
        function populateProfileForm() {
            if (storedUser) {
                document.getElementById('editName').value = `${storedUser.firstName} ${storedUser.lastName}`;
                document.getElementById('editUsername').value = storedUser.username;
                document.getElementById('editRole').value = storedUser.role;
                document.getElementById('editService').value = storedUser.service;
                document.getElementById('editEmail').value = storedUser.email;
                document.getElementById('editPhone').value = storedUser.phone || '';
                document.getElementById('profileAlert').innerHTML = '';
            }
        }
        
        // G√©rer la soumission du formulaire de Profil
        document.getElementById('profileForm').onsubmit = function(e) {
            e.preventDefault();
            const alertDiv = document.getElementById('profileAlert');
            
            const updatedUser = {
                ...storedUser,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
            };
            
            updateStoredUser(updatedUser);
            
            alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Profil mis √† jour !</div>';
            // Mettre √† jour l'info de l'utilisateur dans le header
            document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
            setTimeout(() => alertDiv.innerHTML = '', 3000); // Cacher apr√®s 3s
        };
        
        // G√©rer la soumission du formulaire de Mot de Passe
        document.getElementById('passwordForm').onsubmit = function(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const alertDiv = document.getElementById('securityAlert');

            if (!storedUser) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Erreur utilisateur. Veuillez vous d√©connecter et r√©essayer.</div>';
                return;
            }

            if (oldPassword !== storedUser.password) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå L\'ancien mot de passe est incorrect.</div>';
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Le nouveau mot de passe et sa confirmation ne correspondent pas.</div>';
                return;
            }
            
            if (newPassword.length < 6) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ùå Le nouveau mot de passe doit contenir au moins 6 caract√®res.</div>';
                return;
            }

            // Mise √† jour du mot de passe
            const updatedUser = {
                ...storedUser, 
                password: newPassword
            };
            updateStoredUser(updatedUser);
            
            // R√©initialiser le formulaire
            document.getElementById('passwordForm').reset();
            
            alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Mot de passe mis √† jour avec succ√®s ! Veuillez vous reconnecter.</div>';
            
            // D√©connexion forc√©e apr√®s changement de mot de passe pour la s√©curit√©
            setTimeout(clearAuthData, 2000); 
        };

        // --- Fonctions de l'Application ---
        
        function startApp() {
            loadData(); // Charger les donn√©es avant d'afficher l'application
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.body.style.alignItems = 'flex-start'; // Alignement normal pour l'application
            document.body.style.padding = '20px'; // Re-appliquer le padding du body

            document.getElementById('currentUserInfo').textContent = `${storedUser.firstName} ${storedUser.lastName} (${storedUser.role} - ${storedUser.service})`;
            document.getElementById('currentServiceDisplay').textContent = storedUser.service;
            document.getElementById('listServiceDisplay').textContent = storedUser.service; // Mettre √† jour l'affichage dans la liste

            showMainMenu();
            updateStats();
        }

        // --- Fonctions de navigation et de gestion des donn√©es ---
        function showSection(sectionId) {
            // Cacher toutes les sections de contenu
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });

            // Cacher le menu principal
            document.getElementById('mainMenu').style.display = 'none';

            // Afficher la section demand√©e
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }

            // Masquer les d√©tails de patient dans l'ancienne consultation si on navigue ailleurs
            if (sectionId !== 'oldConsultation') {
                document.getElementById('patientDetails').classList.add('hidden');
            }

            // Masquer le bouton de bascule des services s'il est r√©siduel
            const existingBtn = document.getElementById('toggleButtonContainer');
            if (existingBtn) existingBtn.remove();
            
            // Logique pour la section 'settings'
            if (sectionId === 'settings') {
                document.getElementById('settingsMenu').classList.remove('hidden');
                document.querySelectorAll('#settings .patient-details').forEach(area => {
                    area.classList.add('hidden');
                });
                populateProfileForm(); // Remplir le formulaire de profil
            }
            
            // Logique pour la section 'oldConsultation'
            if (sectionId === 'oldConsultation') {
                searchPatients(); // Relancer la recherche pour afficher la liste r√©cente par d√©faut
            }
            
            // R√©initialiser les champs de l'√©tape 2 (Prescription) si on y revient
            if (sectionId === 'prescriptionEditor') {
                document.getElementById('prescriptionContent').value = currentPrescription || '';
                document.getElementById('editorAlert').innerHTML = '';
            }
            
            // Logique pour les stats
            if (sectionId === 'stats') {
                updateStats();
            }
        }

        function showMainMenu() {
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById('mainMenu').style.display = 'grid';
            document.getElementById('patientDetails').classList.add('hidden');
            updateStats(); // Mettre √† jour les stats du dashboard

            // R√©initialiser l'affichage du menu des param√®tres
            if(document.getElementById('settingsMenu')) {
                document.getElementById('settingsMenu').classList.remove('hidden');
                document.querySelectorAll('#settings .patient-details').forEach(area => {
                    area.classList.add('hidden');
                });
            }
        }
        
        // Fonction pour afficher une sous-section des param√®tres
        function showSettingsSubSection(subSectionId) {
             // Cacher toutes les sous-sections et le menu
             document.getElementById('settingsMenu').classList.add('hidden');
             document.querySelectorAll('#settings .patient-details').forEach(area => {
                 area.classList.add('hidden');
             });

             // Afficher la sous-section demand√©e
             const subSection = document.getElementById(subSectionId);
             if (subSection) {
                 subSection.classList.remove('hidden');
             }
        }
        
        // --- Fonctions de Consultation ---
        
        // √âtape 1: Cr√©ation d'un nouveau patient (ou d√©tection d'un doublon)
        document.getElementById('newPatientForm').onsubmit = function(e) {
            e.preventDefault();
            const patientName = document.getElementById('patientName').value.trim();
            const patientId = patientName.substring(0, 3).toUpperCase() + Math.floor(Math.random() * 10000);
            
            const existingPatient = patients.find(p => p.name.toLowerCase() === patientName.toLowerCase());
            
            const patient = {
                id: patientId,
                name: patientName,
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                profession: document.getElementById('patientProfession').value,
                phone: document.getElementById('patientPhone').value,
                address: document.getElementById('patientAddress').value,
                service: document.getElementById('serviceType').value, // Service d'enregistrement initial
            };
            
            if (existingPatient) {
                const alertDiv = document.getElementById('newConsultAlert');
                alertDiv.innerHTML = `<div class="alert alert-error">‚ö†Ô∏è Le patient "${patient.name}" (ID: ${existingPatient.id}) existe d√©j√†. Veuillez utiliser la section 'Ancienne Consultation' pour continuer son dossier.</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 4000);
                return;
            }

            currentPatient = patient;
            patients.push(patient);
            saveData();

            // Pr√©parer l'√©diteur de prescription (√âtape 2)
            document.getElementById('currentPatientNameDisplay2').textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
            document.getElementById('newPatientForm').reset();
            
            // R√©initialiser la variable temporaire de l'√©tape 2
            currentPrescription = '';

            showSection('prescriptionEditor');
        };

        // G√©rer la soumission du formulaire de Prescription (√âtape 2)
        document.getElementById('prescriptionForm').onsubmit = function(e) {
            e.preventDefault();
            goToSummary();
        };

        // √âtape 2: Prescription -> √âtape 3: R√©sum√©
        function goToSummary() {
            currentPrescription = document.getElementById('prescriptionContent').value;
            
            if (!currentPatient) {
                alert("Erreur: Le patient actuel n'est pas d√©fini. Veuillez recommencer la consultation.");
                showSection('newConsultation');
                return;
            }

            // Pr√©parer le r√©sum√© (√âtape 3)
            document.getElementById('currentPatientNameDisplay3').textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;

            // Pr√©-remplir les informations du soignant √† partir du profil
            document.getElementById('doctorName').value = `${storedUser.firstName} ${storedUser.lastName}`;
            document.getElementById('doctorContact').value = storedUser.phone || storedUser.email;
            document.getElementById('doctorService').value = storedUser.service;
            // Ne pas r√©initialiser consultationCenter s'il a d√©j√† √©t√© rempli
            if (!document.getElementById('consultationCenter').value) {
                document.getElementById('consultationCenter').value = 'Centre de Consultation par d√©faut';
            }


            document.getElementById('editorAlert').innerHTML = ''; // Nettoyer les alertes
            showSection('medicalSummary');
        }

        // √âtape 3: Sauvegarde de la consultation
        function saveConsultation() {
            if (!currentPatient) {
                alert("Erreur: Le patient actuel n'est pas d√©fini. Veuillez recommencer la consultation.");
                showSection('newConsultation');
                return;
            }
            
            const diseaseType = document.getElementById('diseaseType').value;
            const doctorName = document.getElementById('doctorName').value;
            const doctorService = document.getElementById('doctorService').value;
            const consultationCenter = document.getElementById('consultationCenter').value;
            
            if (!diseaseType || !doctorName || !doctorService || !consultationCenter) {
                alert("Veuillez remplir tous les champs obligatoires du R√©sum√© M√©dical (marqu√©s par *).");
                return;
            }

            const consultation = {
                id: 'CONS-' + Date.now(),
                patientId: currentPatient.id,
                date: new Date().toISOString().split('T')[0], // Date du jour
                prescriptionContent: currentPrescription,
                disease: diseaseType, // Maladie pour les stats
                observations: document.getElementById('summaryText').value,
                doctorName: doctorName,
                doctorContact: document.getElementById('doctorContact').value,
                service: doctorService,
                center: consultationCenter
            };

            consultations.push(consultation);
            saveData();
            
            currentPatient = null; // R√©initialiser le patient
            currentPrescription = '';

            alert(`‚úÖ Consultation enregistr√©e pour le patient ${consultation.patientId} !`);
            document.getElementById('summaryForm').reset();
            showMainMenu();
        }

        // --- Fonctions Ancienne Consultation ---
        
        // Logique de recherche de patients 
        function searchPatients() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const listContentDiv = document.getElementById('patientListContent'); // Cibler la zone de contenu interne
            const patientsListContainer = document.querySelector('.patients-list-container');
            
            const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation g√©n√©rale';

            // Mettre √† jour le service affich√© dans l'en-t√™te de la liste
            document.getElementById('listServiceDisplay').textContent = serviceDuSoignant;

            // 1. D√©terminer les ID des patients vus dans CE service
            const patientIdsInService = new Set(
                consultations
                    .filter(c => c.service === serviceDuSoignant)
                    .map(c => c.patientId)
            );
            
            // 2. Filtrer la liste des patients en fonction de ces IDs
            const patientsInService = patients.filter(p => patientIdsInService.has(p.id));

            // 3. Trie et filtre selon la requ√™te de recherche.
            let patientsToShow = patientsInService.slice().sort((a, b) => {
                 // Trie par la date de la derni√®re consultation DANS LE SERVICE ACTUEL
                const lastA = consultations.filter(c => c.patientId === a.id && c.service === serviceDuSoignant).sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
                const lastB = consultations.filter(c => c.patientId === b.id && c.service === serviceDuSoignant).sort((x, y) => new Date(y.date) - new Date(x.date))[0]?.date || '1970-01-01';
                return new Date(lastB) - new Date(lastA);
            });
            
            if (query.length >= 2) {
                patientsToShow = patientsToShow.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    p.id.toLowerCase().includes(query) || 
                    (p.phone && p.phone.toLowerCase().includes(query))
                );
            } else {
                // Si la requ√™te est vide, afficher seulement les 10 derniers patients vus dans le service
                patientsToShow = patientsToShow.slice(0, 10);
            }


            if (patientsToShow.length === 0) {
                const message = query.length < 2 && patientsInService.length > 0
                    ? `Tapez au moins 2 lettres pour filtrer dans votre liste de ${patientsInService.length} patients.`
                    : 'Aucun patient trouv√© correspondant √† la recherche (ou aucun patient consult√© dans votre service).';

                listContentDiv.innerHTML = `<p style="padding: 10px;">${message}</p>`;
                patientsListContainer.style.display = 'block';
            } else {
                const resultsHtml = patientsToShow.map(p => {
                     // Trouver la date de la derni√®re consultation DANS LE SERVICE ACTUEL
                    const lastConsultation = consultations
                        .filter(c => c.patientId === p.id && c.service === serviceDuSoignant)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        
                    const lastConsultDate = lastConsultation ? new Date(lastConsultation.date).toLocaleDateString('fr-FR') : 'N/A';
                    
                    return `
                    <div class="patient-search-card" onclick="showPatientDetails('${p.id}')">
                        <div>
                            <a href="#" onclick="event.preventDefault();">${p.name}</a>
                            <small>‚Ä¢ ${p.age} ans, ${p.gender === 'M' ? 'Homme' : 'Femme'}</small>
                        </div>
                        <div style="text-align: right;">
                            <small>Derni√®re consult. : ${lastConsultDate}</small><br>
                            <span style="font-size: 0.85em; color: #495057;">ID: ${p.id}</span>
                        </div>
                    </div>
                    `;
                }).join('');
                listContentDiv.innerHTML = resultsHtml;
                patientsListContainer.style.display = 'block';
            }

            document.getElementById('patientDetails').classList.add('hidden');
        }
        
        function showPatientDetails(patientId, showAll = false) {
            currentPatient = patients.find(p => p.id === patientId);

            if (!currentPatient) {
                alert("Patient non trouv√©.");
                return;
            }

            document.getElementById('patientDetails').classList.remove('hidden');

            // 1. Afficher les infos patient
            const patientInfoDiv = document.getElementById('patientInfo');
            patientInfoDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>ID Patient</label>
                        <p>${currentPatient.id}</p>
                    </div>
                    <div class="form-group">
                        <label>Nom Complet</label>
                        <p><strong>${currentPatient.name}</strong></p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>√Çge</label>
                        <p>${currentPatient.age} ans</p>
                    </div>
                    <div class="form-group">
                        <label>Sexe</label>
                        <p>${currentPatient.gender === 'M' ? 'Masculin' : 'F√©minin'}</p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Profession</label>
                        <p>${currentPatient.profession || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <p>${currentPatient.phone || 'N/A'}</p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Adresse</label>
                        <p>${currentPatient.address || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Service d'Enregistrement Initial</label>
                        <p>${currentPatient.service || 'N/A'}</p>
                    </div>
                </div>
            `;
            
            // Nettoyer le bouton de bascule pr√©c√©dent
            const existingBtn = document.getElementById('toggleButtonContainer');
            if (existingBtn) existingBtn.remove();
            
            // 2. Afficher l'historique (par d√©faut, filtre par service de l'utilisateur)
            renderHistory(patientId, showAll);
        }

        // Fonction pour afficher l'historique des consultations
        function renderHistory(patientId, showAll) {
            const serviceDuSoignant = storedUser ? storedUser.service : 'Consultation g√©n√©rale';
            const historyDiv = document.getElementById('consultationHistory');

            let patientConsultations = consultations
                .filter(c => c.patientId === patientId)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Trie du plus r√©cent au plus ancien

            if (!showAll) {
                patientConsultations = patientConsultations.filter(c => c.service === serviceDuSoignant);
            }
            
            // Rendre l'historique
            let historyHtml = `<h3 class="details-section-header">${showAll ? 'Historique complet des consultations' : `Historique (Service : ${serviceDuSoignant})`} (${patientConsultations.length} r√©sultats)</h3>`;

            if (patientConsultations.length === 0) {
                historyHtml += `<p>Aucune consultation trouv√©e ${showAll ? '' : `dans le service ${serviceDuSoignant}`}.</p>`;
            } else {
                historyHtml += patientConsultations.map(c => {
                    const isOtherService = c.service !== serviceDuSoignant;
                    const cardClass = `consultation-item-maquette ${isOtherService ? 'other-service' : ''}`;
                    const serviceNote = isOtherService ? `(Service: ${c.service})` : '';
                    
                    const formattedPrescriptionContent = c.prescriptionContent || 'N/A';
                    
                    return `
                    <div class="${cardClass}">
                        <h4>Consultation du ${new Date(c.date).toLocaleDateString('fr-FR')} ${serviceNote} :</h4>
                        
                        <div class="info-line"><strong>‚Ä¢ Type de Maladie :</strong> ${c.disease || 'N/A'}</div>

                        <div style="margin-bottom: 8px;">
                            <strong>‚Ä¢ Prescription/Notes d√©taill√©es :</strong>
                            <div style="margin-top: 5px; border: 1px solid #eee; padding: 5px; white-space: pre-wrap; font-family: monospace; overflow-x: auto;">
                                ${formattedPrescriptionContent}
                            </div>
                        </div>
                        
                        <div class="info-line"><strong>‚Ä¢ Observations Utiles :</strong> ${c.observations || 'N/A'}</div>
                        
                        <hr style="margin: 10px 0; border: 0; border-top: 1px dashed #ccc;">

                        <div class="info-line"><strong>‚Ä¢ Soignant :</strong> ${c.doctorName || 'N/A'}</div>
                        
                        <div class="info-line"><strong>‚Ä¢ Contact du Soignant :</strong> ${c.doctorContact || 'N/A'}</div>
                        
                        <div class="info-line"><strong>‚Ä¢ Service (Cons.) :</strong> ${c.service || 'N/A'}</div>
                        
                        <div class="info-line"><strong>‚Ä¢ Centre :</strong> ${c.center || 'N/A'}</div>
                    </div>
                    `;
                }).join('')
            }
            
            historyDiv.innerHTML = historyHtml;

            // 4. Ajouter le bouton de bascule
            const existingBtn = document.getElementById('toggleButtonContainer');
            if (existingBtn) existingBtn.remove(); // Supprimer l'ancien bouton s'il existe

            if (consultations.filter(c => c.patientId === patientId && c.service !== serviceDuSoignant).length > 0) {
                const toggleButtonContainer = document.createElement('div');
                toggleButtonContainer.id = 'toggleButtonContainer';
                toggleButtonContainer.style.textAlign = 'center';
                toggleButtonContainer.style.marginTop = '20px';

                let buttonHtml = '';
                if (showAll) {
                    buttonHtml = `<button class="btn btn-secondary" style="width: auto;" onclick="renderHistory('${patientId}', false)">
                        ‚úñÔ∏è Cacher les consultations d'autres services
                    </button>`;
                } else {
                     buttonHtml = `<button class="btn btn-secondary" style="width: auto;" onclick="renderHistory('${patientId}', true)">
                        üëÄ Afficher toutes les consultations (y compris autres services)
                    </button>`;
                }
                toggleButtonContainer.innerHTML = buttonHtml;
                historyDiv.parentNode.insertBefore(toggleButtonContainer, historyDiv.nextSibling); // Ins√®re apr√®s le div d'historique
            }
        }
        
        // Continuer consultation (Va √† l'√©tape 2)
        function continueConsultation() {
            document.getElementById('currentPatientNameDisplay2').textContent = `${currentPatient.name} (ID: ${currentPatient.id})`;
            
            // R√©initialiser les champs de l'√©tape 2
            currentPrescription = '';
            document.getElementById('prescriptionContent').value = '';
            
            showSection('prescriptionEditor');
        }

        // --- Fonctions de l'√©diteur de prescription (Ajouter tableau) ---
        function addTable() {
            const contentArea = document.getElementById('prescriptionContent');
            let columns = parseInt(prompt("Entrez le nombre de colonnes (max 4):", 3)) || 3;
            let rows = parseInt(prompt("Entrez le nombre de lignes (max 10):", 4)) || 4;

            if (isNaN(columns) || columns < 1 || columns > 4) {
                alert("Nombre de colonnes invalide. Le tableau aura 3 colonnes par d√©faut.");
                columns = 3;
            }
            if (isNaN(rows) || rows < 1 || rows > 10) {
                alert("Nombre de lignes invalide. Le tableau aura 4 lignes par d√©faut.");
                rows = 4;
            }

            // Largeur de la cellule : 60 caract√®res disponibles au total
            const totalWidth = 60;
            // cellWidth est la largeur interne (sans les espaces de padding et les bordures)
            const cellWidth = Math.floor(totalWidth / columns) - 2; 

            let tableContent = '\n';
            
            // Fonction pour cr√©er une ligne de s√©paration
            const createSeparator = (cols) => {
                let sep = '+';
                for (let i = 0; i < cols; i++) {
                    sep += '-'.repeat(cellWidth + 2) + '+';
                }
                return sep;
            };

            // Fonction pour cr√©er le contenu d'une ligne
            const createRow = (cols, isHeader = false, rowNum = 0) => {
                let row = '|';
                for (let i = 0; i < cols; i++) {
                    let cellContent;
                    if (isHeader) {
                        cellContent = `TITRE ${i + 1}`;
                    } else {
                        cellContent = `Ligne ${rowNum}, Colonne ${i + 1}`;
                    }
                    
                    // Tronquer ou padder le contenu
                    if (cellContent.length > cellWidth) {
                        cellContent = cellContent.substring(0, cellWidth - 3) + '...';
                    }
                    // Paddage : (cellWidth - cellContent.length) / 2 pour centrer
                    const paddingLeft = ' '.repeat(Math.floor((cellWidth - cellContent.length) / 2));
                    const paddingRight = ' '.repeat(Math.ceil((cellWidth - cellContent.length) / 2));
                    
                    row += ` ${paddingLeft}${cellContent}${paddingRight} |`;
                }
                return row;
            };

            // Cr√©er l'en-t√™te (Header)
            tableContent += createSeparator(columns) + '\n';
            tableContent += createRow(columns, true, 0) + '\n'; // Ligne de titre
            tableContent += createSeparator(columns) + '\n';
            
            // Cr√©er les lignes de donn√©es
            for (let r = 1; r <= rows; r++) {
                tableContent += createRow(columns, false, r) + '\n';
                tableContent += createSeparator(columns) + '\n';
            }
            
            tableContent += '\n'; // Espace apr√®s la table

            // Ins√©rer le contenu de la table au niveau du curseur
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            contentArea.value = contentArea.value.substring(0, start) + tableContent + contentArea.value.substring(end);

            // Mettre √† jour la variable globale pour ne pas perdre la modification
            currentPrescription = contentArea.value;

            // D√©placer le curseur apr√®s la nouvelle table
            contentArea.selectionStart = contentArea.selectionEnd = start + tableContent.length;
            contentArea.focus();
        }

        // --- Fonctions Statistiques ---
        function updateStats() {
            // Stats du Dashboard (Consultations dans le service actuel)
            const serviceDuSoignant = storedUser ? storedUser.service : '';
            const consultsInService = consultations.filter(c => c.service === serviceDuSoignant).length;
            document.getElementById('consultationsCount').textContent = consultsInService;

            // Stats de la Section Stats
            document.getElementById('totalConsultsStat').textContent = consultations.length;
            document.getElementById('totalPatientsStat').textContent = patients.length;
            document.getElementById('statsFilter').textContent = 'Tous Services';

            // Top Maladies
            const diseaseCounts = {};
            consultations.forEach(c => {
                const disease = c.disease || 'Non sp√©cifi√©';
                diseaseCounts[disease] = (diseaseCounts[disease] || 0) + 1;
            });

            const sortedDiseases = Object.entries(diseaseCounts)
                .sort(([, countA], [, countB]) => countB - countA)
                .slice(0, 5); // Top 5

            const diseaseList = document.getElementById('topDiseasesList');
            if (sortedDiseases.length > 0) {
                diseaseList.innerHTML = sortedDiseases.map(([disease, count]) => 
                    `<li>${disease}: <strong>${count}</strong> consultations</li>`
                ).join('');
            } else {
                diseaseList.innerHTML = '<li>Aucune donn√©e de consultation pour l\'instant.</li>';
            }
        }


        // D√©marrage de l'application
        window.onload = checkAuth;
    </script>
</body>
</html>